<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB | 系统架构设计与优化</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="拥抱云时代容器化微服务化系统架构">
    <link rel="preload" href="/architecture/assets/css/0.styles.0ca1c2f4.css" as="style"><link rel="preload" href="/architecture/assets/js/app.4c91cc6b.js" as="script"><link rel="preload" href="/architecture/assets/js/2.45685ece.js" as="script"><link rel="preload" href="/architecture/assets/js/11.49a15839.js" as="script"><link rel="prefetch" href="/architecture/assets/js/10.128458a5.js"><link rel="prefetch" href="/architecture/assets/js/12.391d19f8.js"><link rel="prefetch" href="/architecture/assets/js/13.fc661aa7.js"><link rel="prefetch" href="/architecture/assets/js/3.f957054d.js"><link rel="prefetch" href="/architecture/assets/js/4.746e24b3.js"><link rel="prefetch" href="/architecture/assets/js/5.50f24f73.js"><link rel="prefetch" href="/architecture/assets/js/6.7643a53c.js"><link rel="prefetch" href="/architecture/assets/js/7.71363e0d.js"><link rel="prefetch" href="/architecture/assets/js/8.3884ef05.js"><link rel="prefetch" href="/architecture/assets/js/9.db45d323.js">
    <link rel="stylesheet" href="/architecture/assets/css/0.styles.0ca1c2f4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/architecture/" class="home-link router-link-active"><!----> <span class="site-name">系统架构设计与优化</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/architecture/architecture/intro.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.org/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/dotnet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  .Net Core
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/colin-chang/architecture" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/architecture/architecture/intro.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.org/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/dotnet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  .Net Core
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/colin-chang/architecture" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>系统架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/architecture/intro.html" class="sidebar-link">系统架构发展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/architecture/intro.html#_1-单服务器" class="sidebar-link">1. 单服务器</a></li><li class="sidebar-sub-header"><a href="/architecture/architecture/intro.html#_2-多服务器" class="sidebar-link">2. 多服务器</a></li><li class="sidebar-sub-header"><a href="/architecture/architecture/intro.html#_3-服务器集群" class="sidebar-link">3. 服务器集群</a></li><li class="sidebar-sub-header"><a href="/architecture/architecture/intro.html#_4-应用水平拆分-消息队列" class="sidebar-link">4. 应用水平拆分 + 消息队列</a></li><li class="sidebar-sub-header"><a href="/architecture/architecture/intro.html#_5-nosql-搜索引擎服务" class="sidebar-link">5. NoSQL + 搜索引擎服务</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/database/lock.html" class="sidebar-link">数据库锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/database/lock.html#_1-数据库并发" class="sidebar-link">1. 数据库并发</a></li><li class="sidebar-sub-header"><a href="/architecture/database/lock.html#_2-数据库锁" class="sidebar-link">2. 数据库锁</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>NoSQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/nosql/intro.html" class="sidebar-link">NoSQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/nosql/intro.html#_1-nosql简介" class="sidebar-link">1. NoSQL简介</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/intro.html#_2-nosql优缺点" class="sidebar-link">2. NoSQL优缺点</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/intro.html#_3-nosql-数据库分类" class="sidebar-link">3. NoSQL 数据库分类</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/intro.html#_4-网络安全" class="sidebar-link">4. 网络安全</a></li></ul></li><li><a href="/architecture/nosql/redis.html" class="sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_1-redis-简介" class="sidebar-link">1. Redis 简介</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_2-redis-安装" class="sidebar-link">2. Redis 安装</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_3-redis-数据类型" class="sidebar-link">3. Redis 数据类型</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_4-高级操作" class="sidebar-link">4. 高级操作</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_5-redis-集群" class="sidebar-link">5. Redis 集群</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/redis.html#_6-应用程序交互" class="sidebar-link">6. 应用程序交互</a></li></ul></li><li><a href="/architecture/nosql/mongo.html" aria-current="page" class="active sidebar-link">MongoDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_1-mongo-基础" class="sidebar-link">1. Mongo 基础</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_2-mongo-安装" class="sidebar-link">2. Mongo 安装</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_3-mongo-数据类型" class="sidebar-link">3. Mongo 数据类型</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_4-mongo-shell" class="sidebar-link">4. Mongo Shell</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_5-索引" class="sidebar-link">5. 索引</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_6-安全管理" class="sidebar-link">6. 安全管理</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_7-mongo-集群" class="sidebar-link">7. Mongo 集群</a></li><li class="sidebar-sub-header"><a href="/architecture/nosql/mongo.html#_8-应用程序交互" class="sidebar-link">8. 应用程序交互</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>分布式日志</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/log/elk.html" class="sidebar-link">ELK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/log/elk.html#_1-简介" class="sidebar-link">1. 简介</a></li><li class="sidebar-sub-header"><a href="/architecture/log/elk.html#_2-elk环境搭建" class="sidebar-link">2. ELK环境搭建</a></li><li class="sidebar-sub-header"><a href="/architecture/log/elk.html#_3-记录日志" class="sidebar-link">3. 记录日志</a></li><li class="sidebar-sub-header"><a href="/architecture/log/elk.html#_4-查看日志" class="sidebar-link">4. 查看日志</a></li></ul></li><li><a href="/architecture/log/exceptionless.html" class="sidebar-link">Exceptionless</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/log/exceptionless.html#_1-简介" class="sidebar-link">1. 简介</a></li><li class="sidebar-sub-header"><a href="/architecture/log/exceptionless.html#_2-简单使用" class="sidebar-link">2. 简单使用</a></li><li class="sidebar-sub-header"><a href="/architecture/log/exceptionless.html#_3-进阶使用" class="sidebar-link">3. 进阶使用</a></li><li class="sidebar-sub-header"><a href="/architecture/log/exceptionless.html#_4-异常日志模块封装" class="sidebar-link">4. 异常日志模块封装</a></li><li class="sidebar-sub-header"><a href="/architecture/log/exceptionless.html#_5-本地部署" class="sidebar-link">5. 本地部署</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>TODO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/todo.html" class="sidebar-link">Todo List</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/todo.html#_1-to-finish" class="sidebar-link">1. To finish</a></li><li class="sidebar-sub-header"><a href="/architecture/todo.html#_2-todo" class="sidebar-link">2. Todo</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h1> <h2 id="_1-mongo-基础"><a href="#_1-mongo-基础" class="header-anchor">#</a> 1. Mongo 基础</h2> <h3 id="_1-1-mongo"><a href="#_1-1-mongo" class="header-anchor">#</a> 1.1 Mongo</h3> <p>MongoDB 是一个基于分布式文件存储的数据库,旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。</p> <p>MongoDB是专为可扩展性，高性能和高可用性而设计的数据库。它可以从单服务器部署扩展到大型、复杂的多数据中心架构。利用内存计算的优势，MongoDB能够提供高性能的数据读写操作。</p> <p>MongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p> <p>优点:</p> <ul><li>Schema-less,不需要预先定义表结构,同一个“表”中可以保存多个格式的数据;</li> <li>数据支持嵌套,数据以 json 格式存储;</li> <li>允许使用 JavaScript 写服务端脚本,类似于存储过程;</li> <li>支持 Map/Reduce;</li> <li>MongoDB 支持地理位置索引,可以直接用于位置距离计算和查询,实现“附近的人”、 “滴滴打车接单”等很容易;</li></ul> <p>缺点:</p> <ul><li>没有“数据一致性检查”、“事务”等,不适合存储对数据事务要求高(比如金融)的数据;只适合放非关键性数据(比如日志或者缓存)。</li> <li>关联查询很弱,不适合做报表查询</li></ul> <h3 id="_1-2-基本概念"><a href="#_1-2-基本概念" class="header-anchor">#</a> 1.2 基本概念</h3> <table><thead><tr><th style="text-align:left;">SQL术语</th> <th style="text-align:left;">MongoDB术语</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">database</td> <td style="text-align:left;">database</td> <td style="text-align:left;">数据库</td></tr> <tr><td style="text-align:left;">table</td> <td style="text-align:left;">collection</td> <td style="text-align:left;">表/集合</td></tr> <tr><td style="text-align:left;">row</td> <td style="text-align:left;">document</td> <td style="text-align:left;">数据记录行/文档</td></tr> <tr><td style="text-align:left;">column</td> <td style="text-align:left;">field</td> <td style="text-align:left;">数据字段/域</td></tr> <tr><td style="text-align:left;">index</td> <td style="text-align:left;">index</td> <td style="text-align:left;">索引</td></tr> <tr><td style="text-align:left;">primary key</td> <td style="text-align:left;">primary key</td> <td style="text-align:left;">主键,MongoDB自动将_id字段设置为主键</td></tr></tbody></table> <ul><li>MongoDB的单个实例可以容纳多个独立的数据库。每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中。</li> <li>document 是一组键值(key-value)称为BSON(Json的一种扩展)。</li> <li>document 可以设置不同的字段</li> <li>相同的字段可以使用不同的数据类型。</li> <li>document 键/值对是有序的。</li></ul> <h2 id="_2-mongo-安装"><a href="#_2-mongo-安装" class="header-anchor">#</a> 2. Mongo 安装</h2> <p>推荐使用Docker方式简单快速安装 <a href="https://hub.docker.com/_/mongo" target="_blank" rel="noopener noreferrer">Mongo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>docker run <span class="token punctuation">\</span>
-d <span class="token punctuation">\</span>
--name mongo <span class="token punctuation">\</span>
-p <span class="token number">27017</span>:27017 <span class="token punctuation">\</span>
-e <span class="token assign-left variable">MONGO_INITDB_ROOT_USERNAME</span><span class="token operator">=</span>user <span class="token punctuation">\</span>
-e <span class="token assign-left variable">MONGO_INITDB_ROOT_PASSWORD</span><span class="token operator">=</span>password <span class="token punctuation">\</span>
mongo:4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在安装Mongo时会同时安装服务端和客户端。服务端命令为<code>mongod</code>,客户端命令为<code>mongo</code>。使用客户端连接Redis服务之后可以在shell中执行Redis命令。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 连接本地MongoDB服务器</span>
mongo --port <span class="token number">27017</span> -u colin -p <span class="token number">123123</span> --authenticationDatabase admin

<span class="token comment"># 执行mongo shell命令</span>
db
show dbs
use db_test
db.students.find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>除了使用Mongo提供的命令行客户端，我们也可以使用第三方GUI客户端，如如Navicat,<a href="https://robomongo.org/" target="_blank" rel="noopener noreferrer">Robo 3T<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>等。一般客户端软件都提供了Mongo Shell。</p> <p><img src="https://i.loli.net/2020/02/25/AVYwFPEiMzRG7Nd.png" alt="Robo 3T"></p> <h2 id="_3-mongo-数据类型"><a href="#_3-mongo-数据类型" class="header-anchor">#</a> 3. Mongo 数据类型</h2> <table><thead><tr><th style="text-align:left;">数据类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">Object ID</td> <td style="text-align:left;">文档ID</td></tr> <tr><td style="text-align:left;">String</td> <td style="text-align:left;">字符串，最常用，必须是有效的UTF-8</td></tr> <tr><td style="text-align:left;">Boolean</td> <td style="text-align:left;">存储一个布尔值，true或false</td></tr> <tr><td style="text-align:left;">Integer</td> <td style="text-align:left;">整数可以是32位或64位，这取决于服务器</td></tr> <tr><td style="text-align:left;">Double</td> <td style="text-align:left;">存储浮点值</td></tr> <tr><td style="text-align:left;">Arrays</td> <td style="text-align:left;">数组或列表，多个值存储到一个键</td></tr> <tr><td style="text-align:left;">Object</td> <td style="text-align:left;">用于嵌入式的文档，即一个值为一个文档</td></tr> <tr><td style="text-align:left;">Null</td> <td style="text-align:left;">存储Null值</td></tr> <tr><td style="text-align:left;">Timestamp</td> <td style="text-align:left;">时间戳</td></tr> <tr><td style="text-align:left;">Date</td> <td style="text-align:left;">存储当前日期或时间的UNIX时间格式</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">ObjectId</p> <p>MongoDB 中存储的文档必须有一个 <code>_id</code> 键。这个键的值可以是任何类型的，默认是个<code>ObjectId</code>对象。</p></div> <p><code>ObjectId</code>类似唯一主键，可以很快的去生成和排序，包含12B，其含义如下：</p> <ul><li>前四个字节表示创建 unix 时间戳(UTC)</li> <li>接下来的三个字节是机器标识码</li> <li>紧接的两个字节为PID</li> <li>最后三个字节是随机数</li></ul> <p><img src="https://i.loli.net/2020/02/25/7e38cR9brLJU6Ai.jpg" alt="ObjectId结构组成"></p> <p><strong>ObjectId 中保存了创建的时间戳，所以文档中不需要保存时间戳字段</strong>。可以使用<code>getTimestamp()</code>来获取时间。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> objId <span class="token operator">=</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
objId<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 2019-08-30 09:12:48.000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_4-mongo-shell"><a href="#_4-mongo-shell" class="header-anchor">#</a> 4. Mongo Shell</h2> <p>mongo shell是MongoDB的一个组件,它是MongoDB的一个交互式的JavaScript接口，支持JavaScript部分语法，如<code>if/for</code>等流控制语句和<code>function</code>等。用户能够通过mongo shell执行查询、更新数据等操作。</p> <h3 id="_4-1-数据库操作"><a href="#_4-1-数据库操作" class="header-anchor">#</a> 4.1 数据库操作</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 查看当前数据库</span>
db

<span class="token comment">// 查看所有数据库</span>
show dbs

<span class="token comment">// 切换数据库.如果数据库不存在，则指向数据库，但不创建</span>
<span class="token comment">// use db</span>
use db_test

<span class="token comment">// 删除当前数据库,如果数据库不存在，则什么也不做</span>
db<span class="token punctuation">.</span><span class="token function">dropDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-2-集合操作"><a href="#_4-2-集合操作" class="header-anchor">#</a> 4.2 集合操作</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 新建 Collection
* db.createCollection(name[,options])
* name是要创建的集合的名称
* options是一个文档，用于指定集合的配置
	* 参数capped：默认值为false表示不设置上限，值为true表示设置上限
	* 参数size(byte)：当capped值为true时，需要指定此参数，表示集合文件尺寸上限，当文档达到上限时，插入新数据时会首先删除旧数据(优先删除时间最早的数据)
    * 参数max(document count):表示集合document条数上限，超过上限后，插入新数据时会首先删除旧数据(优先删除时间最早的数据)
*/</span>
db<span class="token punctuation">.</span><span class="token function">createCollection</span><span class="token punctuation">(</span><span class="token string">'students'</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">createCollection</span><span class="token punctuation">(</span><span class="token string">'classes'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>capped<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>size<span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">,</span>max<span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// documents超过100B或条数超过10条时会插入数据时会删除最旧的数据</span>

<span class="token comment">// 查看当前db中所有集合</span>
show collections

<span class="token comment">// 删除指定名称的集合</span>
<span class="token comment">//db.collection.drop()</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_4-3-数据操作"><a href="#_4-3-数据操作" class="header-anchor">#</a> 4.3 数据操作</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 插入
* 单条 db.collection.insert(document)
* 批量 db.collection.insertMany(document)
*/</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Jerry'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span>courses<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'Chinee'</span><span class="token punctuation">,</span><span class="token string">'Math'</span><span class="token punctuation">,</span><span class="token string">'English'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Colin'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Robin'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">/* 删除
* db.students.remove([query,options])
* 参数query:必须(可为空)，删除的文档的条件
* 参数justOne:可选，true或1，只删一条，默认false，表示删除多条
*/</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//删除所有学生</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//删除所有18岁的学生</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>gender<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>justOne<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//删除一个男生</span>

<span class="token comment">/* 更新 
* db.collection.update(query, update, options)
* 参数query:更新条件。{}表示匹配所有
* 参数update:更新内容。如果更新字段不存在则会扩展为新字段。使用$set仅更新指定字段，否则将直接替换掉整条document。
* 参数multi:可选。false(默认)表示只更新一条记录，true表示更新满足条件的全部文档
*/</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Colin'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 将name为'Colin'的第一条document直接替换为全新的document，内容为{age:18}</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Robin'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>$set<span class="token operator">:</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 将name为'Robin'的第一条document的age字段更新为18</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>$set<span class="token operator">:</span><span class="token punctuation">{</span>grade<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>multi<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 将所有学生grade更新为1</span>

<span class="token comment">// 保存。如_id存在则替换document，否则新增document</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'Tom'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 新增document</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'5d6900e9ef09a93934746879'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//替换现有document </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_4-4-数据查询"><a href="#_4-4-数据查询" class="header-anchor">#</a> 4.4 数据查询</h3> <h4 id="_4-4-1-简单查询"><a href="#_4-4-1-简单查询" class="header-anchor">#</a> 4.4.1 简单查询</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 查询
* db.collection.find(query, projection) 查询全部document
* db.students.findOne(query, projection) 仅查询一个document
* 参数query:查询条件。不提供此项或{}表示匹配所有
* 参数projection:投影字段。不提供此项则投影全部字段。设置此项时，1表示显示，0或不设置(_id除外)表示不显示。对于_id列默认是显示的，如果不显示需要明确设置为0
*/</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查询所有学生所有字段</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>gender<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询所有男生姓名和年龄</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'grades.English'</span><span class="token operator">:</span><span class="token punctuation">{</span>$gt<span class="token operator">:</span><span class="token number">120</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询英语成绩(二级字段)120分以上的学生。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_1-比较运算符"><a href="#_1-比较运算符" class="header-anchor">#</a> 1) 比较运算符</h4> <table><thead><tr><th style="text-align:left;">功能</th> <th style="text-align:left;">运算符</th></tr></thead> <tbody><tr><td style="text-align:left;">等于</td> <td style="text-align:left;">默认运算，使用Json的<code>:</code></td></tr> <tr><td style="text-align:left;">不等于</td> <td style="text-align:left;"><code>$ne</code></td></tr> <tr><td style="text-align:left;">小于</td> <td style="text-align:left;"><code>$lt</code></td></tr> <tr><td style="text-align:left;">大于</td> <td style="text-align:left;"><code>$gt</code></td></tr> <tr><td style="text-align:left;">小于等于</td> <td style="text-align:left;"><code>$lte</code></td></tr> <tr><td style="text-align:left;">大于等于</td> <td style="text-align:left;"><code>$gte</code></td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gt<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询成年学生信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2-范围运算符"><a href="#_2-范围运算符" class="header-anchor">#</a> 2) 范围运算符</h4> <p>使用<code>$in</code>，<code>$nin</code> 判断是否在某个范围内。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$<span class="token keyword">in</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询年龄为18或20岁的学生</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3-exists"><a href="#_3-exists" class="header-anchor">#</a> 3) exists</h4> <p>查询存在指定字段的数据。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>phone_no<span class="token operator">:</span><span class="token punctuation">{</span>$exists<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询有手机号的学生信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3-逻辑运算符"><a href="#_3-逻辑运算符" class="header-anchor">#</a> 3) 逻辑运算符</h4> <ul><li>逻辑与。使用Json声明多个字段即表示逻辑与，或者可以使用<code>$and</code></li> <li>逻辑或。<code>$or</code></li> <li>取反。<code>$not</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>gender<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询成年男生信息</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$or<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>gender<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询女生或成年学生信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_4-正则匹配"><a href="#_4-正则匹配" class="header-anchor">#</a> 4) 正则匹配</h4> <p>使用<code>//</code>或<code>$regex</code>编写正则表达式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token regex">/^C/</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询名字以C开头的学生</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token punctuation">{</span>$regex<span class="token operator">:</span><span class="token string">'^C'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询名字以C开头的学生</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_5-自定义函数"><a href="#_5-自定义函数" class="header-anchor">#</a> 5) 自定义函数</h4> <p>mongo shell支持使用<code>$where</code>后面写一个函数自定义JavaScript函数作为查询过滤条件。<strong>对于复杂的查询条件，这一功能异常强大实用,甚至可以替代以上所有所有查询过滤运算符</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 查询20~25岁的男生</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token function-variable function">$where</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">&gt;=</span><span class="token number">20</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">&lt;=</span><span class="token number">25</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gender<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_4-4-2-skip-limit"><a href="#_4-4-2-skip-limit" class="header-anchor">#</a> 4.4.2 skip/limit</h4> <p><code>skip(m)</code>表示跳过m条记录，<code>limit(n)</code>表示取n条记录。两者行组合使用，用分页等厂场景。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 跳过4条取2条数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-4-2-sort"><a href="#_4-4-2-sort" class="header-anchor">#</a> 4.4.2 sort</h4> <p><code>sort()</code>，用于对结果集进行排序。1表示升序，-1表示降序。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 查询所有学生并按年龄升序，姓名降序排列</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-4-3-count"><a href="#_4-4-3-count" class="header-anchor">#</a> 4.4.3 count</h4> <p><code>count()</code>用于统计结果集中文档条数。<code>count()</code>可以配合<code>find()</code>使用，也可以单独使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>gender<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 统计男生人数</span>

db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span>gender<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 统计男生人数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_4-4-4-distinct"><a href="#_4-4-4-distinct" class="header-anchor">#</a> 4.4.4 distinct</h4> <p><code>distinct()</code>用于对数据进行去重。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 数据去重</span>
<span class="token comment">// db.collection.distinct(field, query)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//查询成年学生不重复的名字</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-5-aggregate"><a href="#_4-5-aggregate" class="header-anchor">#</a> 4.5 aggregate</h3> <p><code>aggregate()</code>可以利用管道聚合多种高级查询策略。<code>aggregate()</code>的参数为一个数组，每一项是一个管道，首先将管道函数作用于数据，完成后将整体结果作为参数传递给下一个管道，类似于<code>Unix/Linux</code>命令中管道(<code>|</code>)的作用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>pipeline<span class="token operator">:</span><span class="token punctuation">{</span>expression<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>aggregate()</code>不能和<code>find()/sort()/skip()/limit()</code>等函数一起使用，所以管道提供了这些函数的管道版本实现。一般情况下，<strong>这些管道函数最终会与<code>$group</code>一起使用完成聚合，否则可以选择非管道的普通函数实现更为简单。</strong></p> <p>下面我们列举的只是常用的部分管道，基本可以覆盖常见查询。如需处理更为复杂的场景，可以参阅<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，MongoDB提供了足够覆盖几乎所有场景的更多复杂且功能强大的管道。</p> <table><thead><tr><th style="text-align:left;">常用管道</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>$match</code></td> <td style="text-align:left;">过滤数据，只输出符合条件的文档</td></tr> <tr><td style="text-align:left;"><code>$project</code></td> <td style="text-align:left;">投影字段，修改输出文档结构，如重命名、增加、删除字段等</td></tr> <tr><td style="text-align:left;"><code>$sort</code></td> <td style="text-align:left;">将输入文档排序后输出</td></tr> <tr><td style="text-align:left;"><code>$skip</code></td> <td style="text-align:left;">跳过指定数量的文档，并返回余下的文档</td></tr> <tr><td style="text-align:left;"><code>$limit</code></td> <td style="text-align:left;">限制聚合管道返回的文档数</td></tr> <tr><td style="text-align:left;"><code>$group</code></td> <td style="text-align:left;">将集合中的文档分组，可用于统计结果</td></tr> <tr><td style="text-align:left;"><code>$unwind</code></td> <td style="text-align:left;">将数组类型的字段拆分为多条文档</td></tr></tbody></table> <h4 id="_4-5-1-match-project"><a href="#_4-5-1-match-project" class="header-anchor">#</a> 4.5.1 $match/$project</h4> <p><code>$match</code>是用于过滤数据，只输出符合条件的文档。<code>$project</code>则用于投影选定字段。两者组合使用相当于<code>find(query,projection)</code>的管道版实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 查询成年学生的名字和年龄</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>$match<span class="token operator">:</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>$project<span class="token operator">:</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 非管道实现</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>$project</code>可以进行复杂的字段投影控制，还可以重命名字段。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    $project<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 投影字段</span>
        age<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//投影顶级字段</span>
        <span class="token string">'grades.Math'</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//投影二级字段</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    $project<span class="token operator">:</span><span class="token punctuation">{</span>first_name<span class="token operator">:</span><span class="token string">'$name'</span><span class="token punctuation">}</span> <span class="token comment">//重命名字段</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_4-5-2-skip-limit"><a href="#_4-5-2-skip-limit" class="header-anchor">#</a> 4.5.2 $skip/$limit</h4> <p><code>$skip/$limit</code>是<code>skip()/limit()</code>的管道版实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 取第5-6条学生信息</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>$skip<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>$limit<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 非管道实现</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_4-5-3-sort"><a href="#_4-5-3-sort" class="header-anchor">#</a> 4.5.3 $sort</h4> <p><code>$sort</code>是<code>sort()</code>的管道版实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 查询学生信息以年龄升序，名字降序排列</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>$sort<span class="token operator">:</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 非管道实现</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-5-4-group"><a href="#_4-5-4-group" class="header-anchor">#</a> 4.5.4 $group</h4> <p><code>$group</code>用于将集合中的文档进行分组聚合统计。</p> <ul><li><p><code>_id</code>表示分组的key，<strong><code>_id : null</code> 表示所有数据分为一组，也可以认为不分组</strong>。</p></li> <li><p>字段使用格式为<code>'$filed'</code>。分组中除<code>_id</code>往外，每个字段必须为聚合表达式</p></li> <li><p><code>$group</code>提供了以下常用的分组统计聚合表达式。</p> <table><thead><tr><th style="text-align:left;">分组表达式</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>$sum</code></td> <td style="text-align:left;">计算总和。<code>$sum:1</code>等同于<code>count</code></td></tr> <tr><td style="text-align:left;"><code>$avg</code></td> <td style="text-align:left;">计算平均值</td></tr> <tr><td style="text-align:left;"><code>$min</code></td> <td style="text-align:left;">获取最小值</td></tr> <tr><td style="text-align:left;"><code>$max</code></td> <td style="text-align:left;">获取最大值</td></tr> <tr><td style="text-align:left;"><code>$first</code></td> <td style="text-align:left;">根据资源文档的排序获取第一个文档数据</td></tr> <tr><td style="text-align:left;"><code>$last</code></td> <td style="text-align:left;">根据资源文档的排序获取最后一个文档数据</td></tr> <tr><td style="text-align:left;"><code>$push</code></td> <td style="text-align:left;">按组将特定字段拼接为一个数组字段。<code>$$ROOT</code>表示所有字段。类似于MySql的<code>GROUP_CONCAT</code>。</td></tr></tbody></table></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 统计成年男女生各自人数和平均年龄，以及各组成员的名字列表</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>$match<span class="token operator">:</span> <span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$gte<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>$group<span class="token operator">:</span> <span class="token punctuation">{</span>
            _id<span class="token operator">:</span> <span class="token string">'$gender'</span><span class="token punctuation">,</span>
            total<span class="token operator">:</span> <span class="token punctuation">{</span>$sum<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            avg_age<span class="token operator">:</span> <span class="token punctuation">{</span>$avg<span class="token operator">:</span> <span class="token string">'$age'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            names<span class="token operator">:</span> <span class="token punctuation">{</span>$push<span class="token operator">:</span> <span class="token string">'$name'</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">/* 以下为查询结果
{
    &quot;_id&quot;: true,
    &quot;total&quot;: 4,
    &quot;avg_age&quot;: 24.5,
    &quot;names&quot;: [&quot;Colin&quot;,&quot;Sean&quot;,&quot;Ted&quot;,&quot;Barney&quot;]
}
{
    &quot;_id&quot;: false,
    &quot;total&quot;: 4,
    &quot;avg_age&quot;: 21.75,
    &quot;names&quot;: [&quot;Robin&quot;,&quot;Lily&quot;,&quot;Penny&quot;,&quot;Lily&quot;]
}
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><code>$push</code>中如果要查询全部字段，可以使用<code>$$ROOT</code>代替字段名称。MongoDB作为非关系型数据库可以在分组查询时将各分组的成员列表以嵌套Json的格式查询出来，关系型数据库则无法实现这一点，这也体现了非关系型数据库的灵活性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 查询男女生各自成员列表全部信息</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    $group<span class="token operator">:</span> <span class="token punctuation">{</span>
        _id<span class="token operator">:</span> <span class="token string">'$gender'</span><span class="token punctuation">,</span>
        memebers<span class="token operator">:</span> <span class="token punctuation">{</span>$push<span class="token operator">:</span> <span class="token string">'$$ROOT'</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">/* 以下为查询结果
{
    &quot;_id&quot;: true,
    &quot;memebers&quot;: [
        {
            &quot;_id&quot;: ObjectId(&quot;5d69753fe8929845fe389355&quot;),
            &quot;name&quot;: &quot;Colin&quot;,
            &quot;age&quot;: 18,
            &quot;gender&quot;: true
        },
        ...
    ]
}
{
    &quot;_id&quot;: false,
    &quot;memebers&quot;: [
        {
            &quot;_id&quot;: ObjectId(&quot;5d69753fe8929845fe389356&quot;),
            &quot;name&quot;: &quot;Robin&quot;,
            &quot;age&quot;: 20,
            &quot;gender&quot;: false
        },
        ...
    ]
}
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="_4-5-5-unwind"><a href="#_4-5-5-unwind" class="header-anchor">#</a> 4.5.5 $unwind</h4> <p><code>$unwind</code>可以将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值，这在处理数组字段时非常有用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 假定有集合 areas 数据如下：
[
    {
        &quot;province&quot;: &quot;北京&quot;,
        &quot;cities&quot;: [
            {&quot;name&quot;: &quot;北京&quot;,&quot;GDP&quot;: 30300}
        ]
    },
    {
        &quot;province&quot;: &quot;山东&quot;,
        &quot;cities&quot;: [
            {&quot;name&quot;: &quot;青岛&quot;,&quot;GDP&quot;: 12001},
            {&quot;name&quot;: &quot;泰安&quot;,&quot;GDP&quot;: 3651}
        ]
    }
]
*/</span>

<span class="token comment">//我们可以利用 $unwind 将上面的省市信息按城市拆分后平铺数据</span>
db<span class="token punctuation">.</span>areas<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	<span class="token punctuation">{</span>$unwind<span class="token operator">:</span><span class="token string">'$cities'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>$project<span class="token operator">:</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>province<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>city<span class="token operator">:</span><span class="token string">'$cities'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">/*拆分结果如下：
{
    &quot;province&quot;: &quot;北京&quot;,
    &quot;city&quot;: {&quot;name&quot;: &quot;北京&quot;,&quot;GDP&quot;: 30300}
}
{
    &quot;province&quot;: &quot;山东&quot;,
    &quot;city&quot;: {&quot;name&quot;: &quot;青岛&quot;,&quot;GDP&quot;: 12001}
}
{
    &quot;province&quot;: &quot;山东&quot;,
    &quot;city&quot;: {&quot;name&quot;: &quot;泰安&quot;,&quot;GDP&quot;: 3651}
}
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>拆分字段为空数组、非数组、无字段、null情况下，文档会被自动忽略，如果要包含以上这些情况的文档，需要声明<code>preserveNullAndEmptyArrays:true</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>areas<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    $unwind<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'$cities'</span><span class="token punctuation">,</span>
        preserveNullAndEmptyArrays<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>$unwind</code>是<code>$group</code>的逆操作，前者拆分数据，后者聚合数据。在查询有复杂的数组字段的文档时，可以先使用<code>$unwind</code>将文档按数组字段拆分平铺数据，然后丢给下个管道执行过滤等任意操作，最后丢给<code>$group</code>再将结果聚合，这也体现出在复杂场景下<code>aggregate()</code>聚合多种管道的强大之处。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 现有 areas 集合有如下数据。
* 要求查询出有万亿GDP城市的省份及上榜城市列表，就需要使用多组聚合函数来配合完成
[
    {
        &quot;_id&quot;: ObjectId(&quot;5d6a95d1e8929845fe389366&quot;),
        &quot;province&quot;: &quot;北京&quot;,
        &quot;cities&quot;: [{&quot;name&quot;: &quot;北京&quot;,&quot;GDP&quot;: 30300}]
    },
    {
        &quot;_id&quot;: ObjectId(&quot;5d6a95d1e8929845fe389367&quot;),
        &quot;province&quot;: &quot;山东&quot;,
        &quot;cities&quot;: [
            {&quot;name&quot;: &quot;青岛&quot;,&quot;GDP&quot;: 12001},
            {&quot;name&quot;: &quot;泰安&quot;,&quot;GDP&quot;: 3651}
        ]
    },
    {
        &quot;_id&quot;: ObjectId(&quot;5d6abd5ee8929845fe389371&quot;),
        &quot;province&quot;: &quot;江苏&quot;,
        &quot;cities&quot;: [
            {&quot;name&quot;: &quot;苏州&quot;,&quot;GDP&quot;: 18597},
            {&quot;name&quot;: &quot;南京&quot;,&quot;GDP&quot;: 12820},
            {&quot;name&quot;: &quot;南通&quot;,&quot;GDP&quot;: 8427}
        ]
    }
]
*/</span>

<span class="token comment">// 查询有万亿GDP的省和上榜城市</span>
db<span class="token punctuation">.</span>areas<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	<span class="token punctuation">{</span>$unwind<span class="token operator">:</span><span class="token string">'$cities'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// 按城市拆分</span>
	<span class="token punctuation">{</span>$match<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">'cities.GDP'</span><span class="token operator">:</span><span class="token punctuation">{</span>$gte<span class="token operator">:</span><span class="token number">10000</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 过滤GDP数据</span>
	<span class="token punctuation">{</span>$group<span class="token operator">:</span><span class="token punctuation">{</span>_id<span class="token operator">:</span><span class="token string">'$_id'</span><span class="token punctuation">,</span>province<span class="token operator">:</span><span class="token punctuation">{</span>$first<span class="token operator">:</span><span class="token string">'$province'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>cities<span class="token operator">:</span><span class="token punctuation">{</span>$push<span class="token operator">:</span><span class="token string">'$cities'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 聚合查询结果</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="_5-索引"><a href="#_5-索引" class="header-anchor">#</a> 5. 索引</h2> <p>与关系型数据库类似，MongoDB也支持使用 <a href="https://docs.mongodb.com/manual/indexes/index.html" target="_blank" rel="noopener noreferrer">索引<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提升查询性能。MongoDB在<code>_id(ObjectId)</code>字段上默认建立了索引。</p> <h3 id="_5-1-创建-删除-索引"><a href="#_5-1-创建-删除-索引" class="header-anchor">#</a> 5.1 创建/删除 索引</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 创建索引</span>
<span class="token comment">// db.collection.createIndex( &lt;key and index type specification&gt;, &lt;options&gt; )</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">// 为name字段建立降序索引</span>

<span class="token comment">// 查看索引</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">getIndexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>默认索引名字格式为<code>indexkey_direction</code>。如索引<code>{ item : 1, quantity: -1 }</code>默认名称为<code>item_1_quantity_-1</code>。如有必要也可以使用以下方式自定义索引名称。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 自定义索引名称</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;name_age_index&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>索引一旦建立后名称不可修改，只能删除后重建索引。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 删除索引</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">dropIndex</span><span class="token punctuation">(</span><span class="token string">'name_age_index'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_5-2-索引类型"><a href="#_5-2-索引类型" class="header-anchor">#</a> 5.2 索引类型</h3> <h4 id="_5-2-1-single-field"><a href="#_5-2-1-single-field" class="header-anchor">#</a> 5.2.1 Single Field</h4> <p><a href="https://docs.mongodb.com/manual/core/index-single/" target="_blank" rel="noopener noreferrer">Single Field<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为单字段索引，索引单字段时索引的排序规则不再重要，MongoDB可以任意方向检索索引字段。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// Single Field</span>
db<span class="token punctuation">.</span>areas<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;cities.GDP&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 嵌入式字段索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_5-2-2-compound-index"><a href="#_5-2-2-compound-index" class="header-anchor">#</a> 5.2.2 Compound Index</h4> <p><a href="https://docs.mongodb.com/manual/core/index-compound/" target="_blank" rel="noopener noreferrer">Compound Index<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为复合索引。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>c<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>复合索引的键值顺序使用最左前缀原则。</strong> 如上面创建的索引，执行以下7个查询语句，只有 1、2、3、4 会走索引。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{a:<span class="token string">'hello'</span>}<span class="token punctuation">)</span>                       <span class="token comment">// 1</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{b:<span class="token string">'sogo'</span><span class="token punctuation">,</span> a:<span class="token string">'hello'</span>}<span class="token punctuation">)</span>             <span class="token comment">// 2</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{a:<span class="token string">'hello'</span><span class="token punctuation">,</span>b:<span class="token string">'sogo'</span><span class="token punctuation">,</span> c:<span class="token string">'666'</span>}<span class="token punctuation">)</span>     <span class="token comment">// 3</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{c:<span class="token string">'666'</span><span class="token punctuation">,</span> a:<span class="token string">'hello'</span>}<span class="token punctuation">)</span>              <span class="token comment">// 4</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{b:<span class="token string">'sogo'</span><span class="token punctuation">,</span> c:<span class="token string">'666'</span>}<span class="token punctuation">)</span>               <span class="token comment">// 5</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{b:<span class="token string">'sogo'</span> }<span class="token punctuation">)</span>                       <span class="token comment">// 6</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span>{c:<span class="token string">'666'</span>}<span class="token punctuation">)</span>                         <span class="token comment">// 7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>查询应包含最左索引字段(<code>a</code>)，以索引创建顺序为准，与查询字段顺序无关。</strong></p> <h4 id="_5-2-2-multikey-index"><a href="#_5-2-2-multikey-index" class="header-anchor">#</a> 5.2.2 Multikey Index</h4> <p>MongoDB使用 <a href="https://docs.mongodb.com/manual/core/index-multikey/" target="_blank" rel="noopener noreferrer">Multikey Index<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 索引数组字段。<strong>当我们索引一个数组字段时，MongoDB会自动拆分数组字段进行索引,而不需要开发者干预</strong>。查询数组字段或数据内部字段时<code>Multikey Index</code>都会被使用。</p> <h4 id="_5-2-3-text-indexes"><a href="#_5-2-3-text-indexes" class="header-anchor">#</a> 5.2.3 Text Indexes</h4> <p><a href="https://docs.mongodb.com/manual/core/index-text/" target="_blank" rel="noopener noreferrer">Text Indexs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为全文索引，支持索引文本内容。全文索引可以索引含有文本内容或文本内容数组的字段。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>一个集合最多只能有一个全文索引。</p></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 为文章集合评论字段创建全文索引</span>
db<span class="token punctuation">.</span>articls<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>comments<span class="token operator">:</span><span class="token string">'text'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 全文索引多个字段</span>
db<span class="token punctuation">.</span>articls<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>content<span class="token operator">:</span><span class="token string">'text'</span><span class="token punctuation">,</span>comments<span class="token operator">:</span><span class="token string">'text'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_5-3-索引属性"><a href="#_5-3-索引属性" class="header-anchor">#</a> 5.3 索引属性</h3> <h4 id="_5-3-1-unique-indexes"><a href="#_5-3-1-unique-indexes" class="header-anchor">#</a> 5.3.1 Unique Indexes</h4> <p>唯一性索引要求索引字段内容不重复。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>unique<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//单字段唯一索引</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>unique<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 多字段唯一索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_5-3-2-partial-indexes"><a href="#_5-3-2-partial-indexes" class="header-anchor">#</a> 5.3.2 Partial Indexes</h4> <p>部分索引仅索引满足过滤条件的文档。常用过滤条件如下：</p> <ul><li>$exists</li> <li>$gt, $gte, $lt, $lte</li> <li>$type expressions</li> <li>$and</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 索引成年学生的name和gener字段</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> gender<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> partialFilterExpression<span class="token operator">:</span> <span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token punctuation">{</span> $gte<span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_5-3-3-sparse-indexes"><a href="#_5-3-3-sparse-indexes" class="header-anchor">#</a> 5.3.3 Sparse Indexes</h4> <p>稀疏索引仅索引包含索引字段的文档。可以<code>unique</code>组合使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 索引学生手机号字段(自动排除没有手机号字段的文档)</span>
db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;phone_number&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sparse<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_5-3-4-ttl-indexes"><a href="#_5-3-4-ttl-indexes" class="header-anchor">#</a> 5.3.4 TTL Indexes</h4> <p>TTL(time to live)索引会在指定的超时时间后自动删除文档。常用于日志类集合，如设置日志保存一个月后自动删除。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 设置logs表文档超时时间为1小时。从文档被创建时计时。</span>
db<span class="token punctuation">.</span>logs<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;createdAt&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> expireAfterSeconds<span class="token operator">:</span> <span class="token number">3600</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>指定过期时间除了可以设定有效秒数，也可以指定一个明确过期时间。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>logs<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;expireAt&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> expireAfterSeconds<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>

<span class="token comment">// 该文档会在 2020-07-01 00:00:00 被自动删除</span>
db<span class="token punctuation">.</span>logs<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;expireAt&quot;</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'July 1, 2020 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token string">&quot;logEvent&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
   <span class="token string">&quot;logMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Success!&quot;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_5-4-查询性能分析"><a href="#_5-4-查询性能分析" class="header-anchor">#</a> 5.4 查询性能分析</h3> <p>mongo shell提供了 <code>db.collection.explain()</code> 用于<a href="https://docs.mongodb.com/manual/tutorial/analyze-query-plan/" target="_blank" rel="noopener noreferrer">分析查询性能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>它目前支持对以下函数进行性能分析。</p> <ul><li><code>aggregate()</code></li> <li><code>count()</code></li> <li><code>find()</code></li> <li><code>remove()</code></li> <li><code>update()</code></li> <li><code>distinct()</code></li> <li><code>findAndModify()</code></li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token string">'executionStats'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">999999</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 以下为截取的分析结果，我们可以看到查询语句的执行耗时时间(ms)。
{
    ...
    &quot;executionStats&quot;: {
        &quot;executionSuccess&quot;: true,
        &quot;nReturned&quot;: NumberInt(&quot;1&quot;),
        &quot;executionTimeMillis&quot;: NumberInt(&quot;545&quot;),
        &quot;totalKeysExamined&quot;: NumberInt(&quot;0&quot;),
        &quot;totalDocsExamined&quot;: NumberInt(&quot;1000001&quot;),
        ...
    }
    ...
}
*/</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>explain()</code>可以用于性能优化，如分析建立某个字段索引前后的性能差异等。</p> <h2 id="_6-安全管理"><a href="#_6-安全管理" class="header-anchor">#</a> 6. 安全管理</h2> <h3 id="_6-1-备份与恢复"><a href="#_6-1-备份与恢复" class="header-anchor">#</a> 6.1 备份与恢复</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 备份数据库</span>
<span class="token comment">// mongodump -h host -p port -d database -o output</span>
mongodump <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.200</span> <span class="token operator">-</span>d db_test <span class="token operator">-</span>o <span class="token operator">~</span><span class="token operator">/</span>mongobak

<span class="token comment">// 恢复数据库</span>
<span class="token comment">//mongorestore -h host -p port -d database --dir input_directory</span>
mongorestore <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.200</span> <span class="token operator">-</span>d db_test <span class="token operator">--</span>dir <span class="token operator">~</span><span class="token operator">/</span>mongobak
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_6-2-权限管理"><a href="#_6-2-权限管理" class="header-anchor">#</a> 6.2 权限管理</h3> <p>MongoDB 使用 <code>role-user-database</code> 方式管理数据库权限。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> roles  <span class="token comment">// 查看所有角色</span>
<span class="token keyword">show</span> users  <span class="token comment">// 查看所有用户</span>
<span class="token keyword">show</span> dbs    <span class="token comment">// 查看所有数据库</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th style="text-align:left;">常用系统角色</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>root</code></td> <td style="text-align:left;">超级管理员，默认数据库为<code>admin</code></td></tr> <tr><td style="text-align:left;"><code>read</code></td> <td style="text-align:left;">允许用户读取指定数据库</td></tr> <tr><td style="text-align:left;"><code>readWrite</code></td> <td style="text-align:left;">允许用户读写指定数据库</td></tr></tbody></table> <h4 id="_6-2-1-创建管理员"><a href="#_6-2-1-创建管理员" class="header-anchor">#</a> 6.2.1 创建管理员</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>use admin
db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span><span class="token string">'admin'</span><span class="token punctuation">,</span>
    pwd<span class="token operator">:</span><span class="token string">'123'</span><span class="token punctuation">,</span>
    roles<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>role<span class="token operator">:</span><span class="token string">'root'</span><span class="token punctuation">,</span>db<span class="token operator">:</span><span class="token string">'admin'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_6-2-2-启用安全验证"><a href="#_6-2-2-启用安全验证" class="header-anchor">#</a> 6.2.2 启用安全验证</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 修改配置文件。不同平台下配置文件路径可能不同</span>
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/mongo/mongod.conf 

<span class="token comment"># 添加以下内容。</span>
security:
  authorization: enabled <span class="token comment"># 注意保留空格</span>

<span class="token comment"># 重启mongod</span>
<span class="token function">sudo</span> <span class="token function">service</span> mongod restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_6-2-3-创建普通用户"><a href="#_6-2-3-创建普通用户" class="header-anchor">#</a> 6.2.3 创建普通用户</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 登录 admin</span>
mongo <span class="token operator">-</span>u admin <span class="token operator">-</span>p <span class="token number">123</span> <span class="token operator">--</span>authenticationDatabase admin

<span class="token comment">// 创建普通用户</span>
db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span><span class="token string">'colin'</span><span class="token punctuation">,</span>
    pwd<span class="token operator">:</span><span class="token string">'123'</span><span class="token punctuation">,</span>
    roles<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>role<span class="token operator">:</span><span class="token string">'readWrite'</span><span class="token punctuation">,</span>db<span class="token operator">:</span><span class="token string">'db_test'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>至此，即可使用<code>colin</code>登录，该用户有对<code>db_test</code>读写权限。</p> <h4 id="_6-2-4-修改用户信息"><a href="#_6-2-4-修改用户信息" class="header-anchor">#</a> 6.2.4 修改用户信息</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 修改用户密码和角色</span>
db<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token string">'colin'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    pwd<span class="token operator">:</span> <span class="token string">'123123'</span><span class="token punctuation">,</span>
    roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        role<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        db<span class="token operator">:</span> <span class="token string">'admin'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">Mongo in Docker</p> <p>使用docker容器运行 MongoDB ，创建容器时如果指定了用户名密码则意味着已经开启了安全验证，可以直接管理普通用户。</p></div> <h2 id="_7-mongo-集群"><a href="#_7-mongo-集群" class="header-anchor">#</a> 7. Mongo 集群</h2> <h3 id="_7-1-副本集"><a href="#_7-1-副本集" class="header-anchor">#</a> 7.1 副本集</h3> <p>MongoDB支持多复本集群，集群可以实现故障自动迁移。故障时可以实现主从复本自动切换，故障恢复后可以实现数据自动恢复，确保服务高可用。</p> <p>需要注意的是至少有三个复本才能实现故障时主动自动切换。Master复本可读可写,Slave复本只读。主从复本可以自动进行数据同步。</p> <h3 id="_7-2-集群搭建"><a href="#_7-2-集群搭建" class="header-anchor">#</a> 7.2 集群搭建</h3> <p>下面我们来演示一下使用 docker-compose 快速搭建一个一主二从的集群。</p> <blockquote><p><a href="https://github.com/senssei/mongo-cluster-docker" target="_blank" rel="noopener noreferrer">mongo-cluster-docker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h4 id="_1-启动服务集群"><a href="#_1-启动服务集群" class="header-anchor">#</a> 1) 启动服务集群</h4> <p>三个mongo服务需要设置相同的<code>--replSet</code>选项即集群名称，这里设置集群名称为<code>rs_test</code>。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.7'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongo1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;27017:27017&quot;</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs_test
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongo<span class="token punctuation">-</span>cluster

  <span class="token key atrule">mongo2</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongo2
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;27018:27017&quot;</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs_test
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongo<span class="token punctuation">-</span>cluster

  <span class="token key atrule">mongo3</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongo3
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;27019:27017&quot;</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs_test
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongo<span class="token punctuation">-</span>cluster

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo-cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>docker-compose up --build  <span class="token comment"># 启动服务集群</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2-初始化主从配置"><a href="#_2-初始化主从配置" class="header-anchor">#</a> 2) 初始化主从配置</h4> <p>第一次启动集群后需要进行主从初始化配置。</p> <p>通过任意客户端连接<code>master</code>和<code>slave</code>分别进行以下配置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// master 配置</span>
config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;rs_test&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;members&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;host&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;mongo1:27017&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;host&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;mongo2:27017&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;host&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;mongo3:27017&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

rs<span class="token punctuation">.</span><span class="token function">initiate</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

<span class="token comment">// slave 配置</span>
rs<span class="token punctuation">.</span><span class="token function">slaveOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果没有安装客户端可以直接使用容器内<code>mongo</code>客户端,假如我们选择<code>mongo1</code>为<code>master</code>。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 打开mongo1 客户端</span>
docker <span class="token builtin class-name">exec</span> -it mongo1 mongo

<span class="token comment">## 在此 执行上面的 master 配置即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>以上配置只是初始化配置(仅第一次)，如果之后集群Master复本发生故障，会自动选举新的Master实现主从自动切换。</p> <h4 id="_3-集群维护"><a href="#_3-集群维护" class="header-anchor">#</a> 3) 集群维护</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'192.168.0.200:27020'</span><span class="token punctuation">)</span>  <span class="token comment">// 添加复本</span>

rs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'192.168.0.200:27020'</span><span class="token punctuation">)</span>  <span class="token comment">// 删除复本</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_8-应用程序交互"><a href="#_8-应用程序交互" class="header-anchor">#</a> 8. 应用程序交互</h2> <p>MongoDB 为各开发平台提供的对应Driver，用法类似。下面我们以.NET平台为例，使用官方提供的驱动包 <a href="https://www.nuget.org/packages/MongoDB.Driver/" target="_blank" rel="noopener noreferrer">MongoDB.Driver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。目前版本为2.8.0，支持<code>.NETStandard 1.5</code>。</p> <blockquote><p><a href="https://docs.mongodb.com/ecosystem/drivers/csharp/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="_8-1-连接字符串"><a href="#_8-1-连接字符串" class="header-anchor">#</a> 8.1 连接字符串</h3> <p>标准 URI 连接语法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>mongodb:// 这是固定的格式，必须要指定。</li> <li>username:password@ 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库</li> <li>host1 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接* 复制集，请指定多个主机地址。</li> <li>portX 可选的指定端口，如果不填，默认为27017</li> <li>/database 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开 test 数据库。</li> <li>?options 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</li></ul> <p>常用连接字符串示例:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 连接本地数据库服务器，端口是默认的。</span>
mongodb://localhost

<span class="token comment"># 使用用户名colin，密码123123登录localhost的admin数据库。</span>
mongodb://colin:123123@localhost
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_8-2-mongo-连接池"><a href="#_8-2-mongo-连接池" class="header-anchor">#</a> 8.2 Mongo 连接池</h3> <p>使用 MongoDB 时，可能会遇到因为 mongod 连接数用满了，导致客户端无法连接的问题。mongod的最大连接数通过 net.maxIncomingConnections 指定，默认值为1000000，相当于没有限制，<strong>生产环境强烈建议根据实际需求配置，以避免客户端误用导致 mongod 负载过高。</strong></p> <p>Mongod 的服务模型是每个网络连接由一个单独的线程来处理，每个线程配置了1MB 的栈空间，当网络连接数太多时，过多的线程会导致上下文切换开销变大，同时内存开销也会上涨。每个连接都要打开一个文件句柄，当然从成本上讲，这个消耗相对内存是小了很多。但换个角度，文件句柄也被其他模块消耗着，比如WT存储引擎，就需要消耗大量的文件句柄。链接数的上限需要综合考虑性能，稳定性，业务需求。多方面去考虑，缺一不可。</p> <h4 id="_1）mongo-driver"><a href="#_1）mongo-driver" class="header-anchor">#</a> 1）Mongo Driver</h4> <p>MongoDB 各个语言的Driver 基本都会封装包含一个 MongoClient 的对象，通常应用在使用时构造一个全局 MongoClient，然后在后续的请求中使用该全局对象来发送请求给Mongo。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// global MongoClient object</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// request1</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongo1 <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;db1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;col1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongo1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// request2</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongo2 <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;db2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;col2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongo2<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通常每个 MongoClient 会包含一个连接池，默认大小为100，也可以在连接字符串中通过 maxPoolSize 选项来指定。</p> <p>一种典型的错误使用方式是，用户为每个请求都构造一个 MongoClient，请求结束释放 MongoClient（或根本没释放），这样做问题是请求模型从长连接变成了短连接，每次短连接都会增加“建立 tcp 连接 + mongodb鉴权”的开销，并且并发的请求数会受限于连接数限制，极大的影响性能；另外如果 MongoClient 忘记释放，会导致MongoClient 连接池里连接一直保持着，最终耗光所有的可用连接。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//错误示范</span>

<span class="token comment">// request1</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongoClient1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongo1 <span class="token operator">=</span> mongoClient1<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;db1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;col1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongo1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// request2</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongoClient2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> mongo2 <span class="token operator">=</span> mongoClient1<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;db2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;col2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongo2<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2）连接池配置"><a href="#_2）连接池配置" class="header-anchor">#</a> 2）连接池配置</h4> <p>通常 MongoClient 使用默认100的连接池都没问题，当访问同一个 Mongo 的源比较多时，则需要合理的规划连接池大小。</p> <p>举个例子，Mongo 的连接数限制为2000，应用业务上有40个服务进程可能同时访问 这个Mongod，这时每个进程里的 MongoClient 的连接数则应该限制在 2000 / 40 = 50 以下 （连接复制集时，MongoClient 还要跟复制集的每个成员建立一条连接，用于监控复制集后端角色的变化情况）。</p> <h3 id="_8-3-初始化"><a href="#_8-3-初始化" class="header-anchor">#</a> 8.3 初始化</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//连接到mongo服务器</span>
<span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取指定数据库，如果不存在则创建</span>
<span class="token class-name"><span class="token keyword">var</span></span> database <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取集合(类似&quot;表&quot;),如果不存在则创建</span>
<span class="token class-name"><span class="token keyword">var</span></span> persons <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;persons&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_8-4-filter"><a href="#_8-4-filter" class="header-anchor">#</a> 8.4 Filter</h3> <p>MongoDB.Driver中通过 Filter 对象进行数据过滤,其类型为 FilterDefinition&lt;TDocument&gt;。可以通过 Builders&amp;ltT&amp;gt.Filter 的诸多方法创建过滤器，如 Builders&lt;Person&gt;.Filter.Gt(p =&gt; p.Age,5)</p> <p>常用过滤条件除了<code>Gt</code>还有诸如<code>Gte、In、Lt、Lte、Ne、Nin、Near、NearSphere、Or、Where、And、Not</code>等。最强大的是<code>Where</code>，它可以做复合条件筛选，如 Builders&lt;Person&gt;.Filter.Where(p =&gt; p.Age &gt;= 5 &amp;&amp; p.Gender == &quot;Male&quot;)。</p> <p><strong><code>BsonDocument</code>对象不会过滤任何数据，常用于条件查询中。</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// 筛选出所有女性和成年男性</span>
<span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Gender <span class="token operator">==</span> <span class="token string">&quot;Male&quot;</span>
    <span class="token punctuation">?</span> Builders<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gt</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age <span class="token operator">&gt;=</span> <span class="token number">18</span><span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>数据查询、修改和删除操作常需要配合过滤器使用。</p> <h3 id="_8-5-插入数据"><a href="#_8-5-插入数据" class="header-anchor">#</a> 8.5 插入数据</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//单条数据(document)插入</span>
<span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Colin&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> ps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;Robin&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;Sean&quot;</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//批量数据插入</span>
<span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">InsertManyAsync</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>MongoDB 默认用 id 做主键,因此不用显式指定 id 是主键。MongoDB 中没有内置“自增字段”，如果插入对象没有Id属性或者把 Id 声明为<code>ObjectId</code>类型这样插入以后自动给字段赋值。</p> <p><img src="https://i.loli.net/2020/02/25/DqafHm9PxhGKJQk.jpg" alt="mongo数据格式"></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//json数据插入</span>
<span class="token class-name"><span class="token keyword">var</span></span> persons <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BsonDocument<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;persons&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
persons<span class="token punctuation">.</span><span class="token function">InsertOne</span><span class="token punctuation">(</span>BsonDocument<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">&quot;{Name:'Colin',Age:18}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
persons<span class="token punctuation">.</span><span class="token function">InsertOne</span><span class="token punctuation">(</span>BsonDocument<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">&quot;{Name:'Colin',Age:18,Gender:0}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>MongoDB 是用 json 保存的,因此也可以直接以 json 格式插入,用 <code>BsonDocument</code> 来代表,如果使用<code>BsonDocument</code>类型来代表数据类型，那获取Collection时也必须使用相同类型。Json是松散的数据结构，可以有任意不同字段，不像关系表中数据字段必须一致。</p> <h3 id="_8-6-删除数据"><a href="#_8-6-删除数据" class="header-anchor">#</a> 8.6 删除数据</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//删除数据库</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">DropDatabaseAsync</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//数据Collection</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">DropCollectionAsync</span><span class="token punctuation">(</span><span class="token string">&quot;persons&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//数据Document</span>
<span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age <span class="token operator">&gt;=</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除年龄大于18的所有人</span>
<span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">DeleteManyAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_8-7-更新数据"><a href="#_8-7-更新数据" class="header-anchor">#</a> 8.7 更新数据</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Update<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>p<span class="token operator">=&gt;</span>p<span class="token punctuation">.</span>Age<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
persons<span class="token punctuation">.</span><span class="token function">UpdateMany</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_8-8-查询数据"><a href="#_8-8-查询数据" class="header-anchor">#</a> 8.8 查询数据</h3> <p>1）Count</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//统计成年人总数</span>
<span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gt</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age <span class="token operator">&gt;=</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">CountDocumentsAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>2）Where</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//查询成年男性</span>
<span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age <span class="token operator">&gt;=</span> <span class="token number">18</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>Gender <span class="token operator">==</span> <span class="token string">&quot;Male&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cursor <span class="token operator">=</span> <span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FindAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> ps <span class="token operator">=</span> cursor<span class="token punctuation">.</span>Current<span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> p <span class="token keyword">in</span> ps<span class="token punctuation">)</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>FindAsync</code> 不直接返回集合,而是要 <code>MoveNext</code> 之后返回一个集合呢。因为查询的数据量可能很大,因此 MongoDB 是分批下载,下载一批之后执行 <code>GET_More</code> 操作返回下一批。可以通过 <code>FindOptions</code> 参数的 <code>BatchSize</code> 设置每一批的大小。</p> <p>如果确认返回的数据量不大,可以 <code>var ps = await personsCursor.ToListAsync()</code> (或 <code>ToEnumerable()</code>)一次返回所有数据。</p> <p>3）Sort</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> findOpt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOptions<span class="token punctuation">&lt;</span>Person<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
findOpt<span class="token punctuation">.</span>Sort <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">.</span>Sort<span class="token punctuation">.</span><span class="token function">Ascending</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Age<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Descending</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//年龄生序，姓名降序</span>
<span class="token comment">//查询所有人并按照以上规则排序</span>
<span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">FindAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>4）分页</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> findOpt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOptions<span class="token punctuation">&lt;</span>Person<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
findOpt<span class="token punctuation">.</span>Skip <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//跳过10条</span>
findOpt<span class="token punctuation">.</span>Limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//取10条</span>
<span class="token keyword">await</span> persons<span class="token punctuation">.</span><span class="token function">FindAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_8-9-mongohelper"><a href="#_8-9-mongohelper" class="header-anchor">#</a> 8.9 MongoHelper</h3> <p>仿照关系型数据库中<code>SqlHelper</code>,我们可以将对Mongo的常用操作封装到一个<code>MongoHelper</code>中,支持简单CRUD操作，包含分页、排序、大数量查询等常用功能。</p> <p>代码已上传到 <a href="https://github.com/colin-chang/mongohelper" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这里不再展开。</p> <p>具体使用方式可以查看<a href="https://github.com/colin-chang/MongoHelper/blob/master/ColinChang.MongoHelper.Test/MongoHelperTest.cs" target="_blank" rel="noopener noreferrer">单元测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p><a href="https://www.nuget.org/packages/ColinChang.MongoHelper/" target="_blank" rel="noopener noreferrer">Nuget - ColinChang.MongoHelper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># Package Manager</span>
Install-Package ColinChang.MongoHelper

<span class="token comment"># .NET CLI</span>
dotnet <span class="token function">add</span> package ColinChang.MongoHelper
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/18/2020, 1:58:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/architecture/nosql/redis.html" class="prev">
        Redis
      </a></span> <span class="next"><a href="/architecture/log/elk.html">
        ELK
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/architecture/assets/js/app.4c91cc6b.js" defer></script><script src="/architecture/assets/js/2.45685ece.js" defer></script><script src="/architecture/assets/js/11.49a15839.js" defer></script>
  </body>
</html>
